---
const {Canvas} = Astro.props; 
---
<canvas id="bg-canvas"></canvas>
<style>
  #bg-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-color: var(--bg-color);
    border-color: #268bd2;
  }
</style>

<script>
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  export class ThreeRenderer{
    private canvas!: HTMLCanvasElement;
    private renderer!: THREE.WebGLRenderer;
    private scene!: THREE.Scene;
    private camera!: THREE.PerspectiveCamera;
    private cube!: THREE.Mesh;
    private controls!: OrbitControls;
    private torusMesh!: THREE.Mesh<THREE.TorusKnotGeometry, THREE.MeshStandardMaterial, THREE.Object3DEventMap>;
    private speedx!: number;
    private speedy!: number;

    constructor(canvasSelector = '#bg-canvas') {
      const canvas = document.querySelector(canvasSelector) as HTMLCanvasElement | null;
      if (!canvas) {
        console.error(`Couldn't find canvas: ${canvasSelector}`);
        return;
      }
      this.canvas = canvas;

      this.init();
      this.animate = this.animate.bind(this); // bind once
      this.animate();

      window.addEventListener('resize', () => this.onResize());
    }

    createScene(){
      this.speedx = 0.002;
      this.speedy = 0.002;

      

      this.torusMesh = new THREE.Mesh(
        new THREE.TorusKnotGeometry(3, 0.45, 512, 64, 2, 3),
        new THREE.MeshPhysicalMaterial(
        {
          anisotropy: 0,
          sheen: 1,
          color: 0xffffff,
          emissive: 0x222233,
          metalness: 0.8,
          roughness: 0.20,
          wireframe: true,
        }
        )
      );
      this.scene.add(this.torusMesh);

      const l1 = new THREE.PointLight(0xffffff, 3);
      l1.position.set(5, 5, -5);
      this.scene.add(l1);

      const l2 = new THREE.PointLight(0xffffff, 3);
      l2.position.set(-5, 5, -5);
      this.scene.add(l2);
    }

    animate() {
      requestAnimationFrame(this.animate);
      this.torusMesh.rotation.x += this.speedx;
      this.torusMesh.rotation.y += this.speedy;

      this.controls.update();
      this.renderer.render(this.scene, this.camera);
    }

    init() {
      // Scene
      this.scene = new THREE.Scene();

      // Camera
      this.camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      this.camera.position.set( 0.0, 0.0, -7.0 );

      // Renderer
      this.renderer = new THREE.WebGLRenderer({
        canvas: this.canvas,
        antialias: true,
      });
      this.renderer.setSize(window.innerWidth, window.innerHeight);
      this.renderer.setPixelRatio(window.devicePixelRatio);
      this.renderer.setClearColor(0x000000);

      this.controls = new OrbitControls(this.camera, this.renderer.domElement );


      this.createScene();
    }

    onResize() {
      this.camera.aspect = window.innerWidth / window.innerHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // Getters & Setters
    getSpeedx(): number {
      return this.speedx;
    }
    setSpeedx(spd: number) {
      this.speedx = spd;
    }

    getSpeedy(): number {
      return this.speedy;
    }
    setSpeedy(spd: number) {
      this.speedy = spd;
    }

    setColor(hex: THREE.ColorRepresentation) {
      if (this.torusMesh && this.torusMesh.material instanceof THREE.MeshStandardMaterial) {
        this.torusMesh.material.color = new THREE.Color(hex);
      }
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const three = new ThreeRenderer('#bg-canvas');
    // const btn = document.querySelector('#test');
    // btn?.addEventListener('click', () => {
    //   console.log('Click');
    //   three.setSpeedx(1);
    // });
    window.Background3D = {
      getSpeedx: () => three.getSpeedx(),
      setSpeedx: (spd: number) => three.setSpeedx(spd),
      getSpeedy: () => three.getSpeedy(),
      setSpeedy: (spd: number) => three.setSpeedy(spd),
      setColor: (hex: THREE.ColorRepresentation) => three.setColor(hex)
    };
  });
  
</script>