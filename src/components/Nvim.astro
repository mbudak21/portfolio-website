---
import "../styles/global.css";
const files = [
  { name: "index.html", content: "<html>...</html>" },
  { name: "style.css",  content: "body { color: red; }" },
  { name: "script.js",  content: "console.log('hi');" },
];
---

<div class="nvim nvim-root-div" data-nvim>
  <div class="nvim__left nvim-root-div">
    <div class="nvim__fuzzy nvim-root-div"> Test </div>
    <div class="nvim__list" aria-label="Files">
      <ul>
      {files.map((f, i) => (
        <li class={`${i === 0 ? "is-selected" : ""}`} aria-selected={i === 0} data-index={i}>
          {f.name}
        </li>
      ))}
      </ul>
    </div>
  </div>
  <div class="nvim__content nvim-root-div">
    <pre data-content>{files[0].content}</pre>
  </div>


  <script type="application/json" data-nvim-files>
    [
      { "name": "index.html", "content": "<html>...</html>" },
      { "name": "style.css", "content": "body { color: red; }" },
      { "name": "script.js", "content": "console.log('hi');" }
    ]
  </script>

</div>

<style is:global>
  .nvim-root-div {
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    color: var(--font-color);
  }
  .nvim {
    display: flex;
    gap: 10px; /* space between them */
    min-height: 700px;
    padding: 10px;
  }
  .nvim__left {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 300px;
  }
  .nvim__content {
    flex: 1;
    min-height: 300px;
  }
  .nvim__list ul {
    list-style-type: none;
    padding-left: 0px;
    margin: 0;
  }
  .nvim__list ul li::before {
    content: ">";
    position: absolute;
    left: 2px;
    color: transparent;
  }
  .nvim__list ul li {
    position: relative;
    padding-left: 1em;
    color: var(--font-color);
  }

  .nvim__list ul li.is-selected::before {
    color: var(--heading-color);
  }
  .nvim__list ul li.is-selected {
    background: var(--accent-color);
    color: var(--heading-color);
  }
</style>

<script type="module" data-nvim-script>
  // Get the component root
  const root = document.querySelector('[data-nvim]');
  if (!root) throw new Error('nvim root not found');

  // Read the JSON <script> inside the root (safer scoping)
  const dataEl = root.querySelector('script[data-nvim-files]');
  const files = JSON.parse(dataEl?.textContent ?? '[]');

  console.log(files[0]); // works

  const contentArea = document.querySelector('.nvim__content pre');


  // Assume 0th element is selected
  let selected = 0;

  function setSelection(delta) {
    const newIndex = (selected + delta + files.length) % files.length;
    const currentItem = document.querySelector(`.nvim__list ul li[data-index="${selected}"]`);
    const newItem = document.querySelector(`.nvim__list ul li[data-index="${newIndex}"]`);

    // Remove "is-selected" from the current item
    if (currentItem) {
      currentItem.classList.remove('is-selected');
      currentItem.setAttribute('aria-selected', 'false');
    }

    // Add "is-selected" to the new item
    if (newItem) {
      newItem.classList.add('is-selected');
      newItem.setAttribute('aria-selected', 'true');
    }
    selected = newIndex;
    if (contentArea) {
      contentArea.textContent = files[selected].content;
    }
  }

  //////////////////////////////
  //   Interactivity section  //
  //////////////////////////////

  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') {
      setSelection(1); e.preventDefault();
    }
    else if (e.key === 'ArrowUp') {
      setSelection(-1); e.preventDefault();
    }
  })

  const listItems = document.querySelectorAll('.nvim__list ul li');
  listItems.forEach((item) => {
    item.addEventListener('click', () => {
      const index = parseInt(item.getAttribute('data-index'), 10);
      if (index !== selected) {
        setSelection(index - selected); // Set the new selection by clicking
      }
    });
  });

</script>